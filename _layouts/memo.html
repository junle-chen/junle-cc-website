---
layout: page
---

{{ content }}

<div class="memo-container">
  <div class="add-memo-section">
    <div class="section-header">
      <h3>‚ú® Add New Memo</h3>
      <p class="text-muted">Record your ideas, tasks and important notes</p>
    </div>
    <form id="memoForm">
      <div class="form-group">
        <label for="memoTitle">üìå Title</label>
        <input type="text" id="memoTitle" class="form-control" placeholder="Give your memo a title..." />
      </div>
      <div class="form-group">
        <label for="memoContent">üìù Content</label>
        <textarea id="memoContent" class="form-control" rows="4" placeholder="Enter your memo content... Supports multiple lines"></textarea>
      </div>
      <div class="form-row">
        <div class="form-group col-md-4">
          <label for="memoCategory">üè∑Ô∏è Category</label>
          <select id="memoCategory" class="form-control">
            <option value="general">üìã General</option>
            <option value="todo">‚úÖ Todo</option>
            <option value="idea">üí° Idea</option>
            <option value="note">üìñ Note</option>
          </select>
        </div>
        <div class="form-group col-md-4">
          <label for="memoPriority">‚≠ê Priority</label>
          <select id="memooPriority" class="form-control">
            <option value="normal">Normal</option>
            <option value="important">Important</option>
            <option value="urgent">Urgent</option>
          </select>
        </div>
        <div class="form-group col-md-4">
          <label for="memoVisibility">üîí Visibility</label>
          <select id="memoVisibility" class="form-control">
            <option value="public" selected>üåç Public (sync to server)</option>
            <option value="private">üîê Private (local only)</option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <label>üìé Attachments</label>
        <div class="attachment-section">
          <div class="file-upload-area">
            <input type="file" id="imageUpload" accept="image/*" multiple style="display: none;" />
            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="document.getElementById('imageUpload').click()">
              üñºÔ∏è Add Images
            </button>
            <input type="file" id="fileUpload" multiple style="display: none;" />
            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="document.getElementById('fileUpload').click()">
              üìÑ Add Files
            </button>
            <span class="upload-hint">Multiple files supported</span>
          </div>
          <div id="attachmentPreview" class="attachment-preview"></div>
        </div>
      </div>
      <button type="submit" class="btn btn-primary btn-lg btn-block">
        <span>‚ûï Add Memo</span>
      </button>
    </form>
    <div id="addMemoMessage"></div>
  </div>

  <div class="memos-list">
    <div class="list-header">
      <h3>üìö My Memos</h3>
      <div class="stats">
        <span id="memoCount" class="badge badge-info">0 memos</span>
        <span id="publicCount" class="badge badge-success">0 public</span>
        <span id="privateCount" class="badge badge-warning">0 private</span>
      </div>
    </div>
    
    <div class="filter-section">
      <div class="filter-buttons">
        <button class="filter-btn active" data-category="all">All</button>
        <button class="filter-btn" data-category="general">üìã General</button>
        <button class="filter-btn" data-category="todo">‚úÖ Todo</button>
        <button class="filter-btn" data-category="idea">üí° Idea</button>
        <button class="filter-btn" data-category="note">üìñ Note</button>
      </div>
      <div class="visibility-filters" style="margin-top: 10px;">
        <button class="visibility-btn active" data-visibility="all">All</button>
        <button class="visibility-btn" data-visibility="public">üåç Public</button>
        <button class="visibility-btn" data-visibility="private">üîê Private</button>
      </div>
      <div class="search-box">
        <input type="text" id="searchInput" class="form-control" placeholder="üîç Search memos..." />
      </div>
    </div>
    
    <div id="memosDisplay">
      {% if site.data.memos %}
        {% assign sorted_memos = site.data.memos | sort: 'date' | reverse %}
        {% for memo in sorted_memos %}
        <div class="memo-item priority-{{ memo.priority | default: 'normal' }}" data-category="{{ memo.category }}" data-id="{{ memo.id }}">
          <div class="memo-header">
            <div class="header-left">
              {% if memo.title %}
              <h5 class="memo-title">{{ memo.title }}</h5>
              {% else %}
              <h5 class="memo-title text-muted">Êó†Ê†áÈ¢òÂ§áÂøò</h5>
              {% endif %}
            </div>
            <div class="header-right">
              {% if memo.priority == 'urgent' %}
              <span class="priority-badge urgent">üî• Á¥ßÊÄ•</span>
              {% elsif memo.priority == 'important' %}
              <span class="priority-badge important">‚≠ê ÈáçË¶Å</span>
              {% endif %}
              <span class="memo-category badge-{{ memo.category }}">
                {% if memo.category == 'general' %}General
                {% elsif memo.category == 'todo' %}Todo
                {% elsif memo.category == 'idea' %}Idea
                {% elsif memo.category == 'note' %}Note
                {% else %}{{ memo.category }}{% endif %}
              </span>
            </div>
          </div>
          <div class="memo-content">{{ memo.content }}</div>
          {% if memo.images or memo.files %}
          <div class="memo-attachments">
            {% if memo.images %}
              <div class="images-grid">
                {% for image in memo.images %}
                <img src="{{ image }}" alt="attachment" class="attachment-image" onclick="openImageModal(this.src)" />
                {% endfor %}
              </div>
            {% endif %}
            {% if memo.files %}
              <div class="files-list">
                {% for file in memo.files %}
                <a href="{{ file.url }}" class="file-item" download="{{ file.name }}">
                  üìé {{ file.name }}
                </a>
                {% endfor %}
              </div>
            {% endif %}
          </div>
          {% endif %}
          <div class="memo-footer">
            <span class="memo-date">üïê {{ memo.date }}</span>
            <div class="memo-actions">
              <button class="btn-icon" onclick="toggleComplete({{ memo.id }})" title="Mark as complete">
                <span class="complete-icon">‚úì</span>
              </button>
              <button class="btn-icon" onclick="deleteMemo({{ memo.id }})" title="Delete">
                <span class="delete-icon">üóëÔ∏è</span>
              </button>
            </div>
          </div>
        </div>
        {% endfor %}
      {% else %}
        <div class="empty-state">
          <div class="empty-icon">üìù</div>
          <p>No memos yet</p>
          <p class="text-muted">Add your first memo now!</p>
        </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Image Modal -->
<div id="imageModal" class="image-modal" onclick="closeImageModal()">
  <span class="close-modal">&times;</span>
  <img class="modal-content" id="modalImage">
  <div id="caption"></div>
</div>

<style>
:root {
  --primary-color: #0288D1;
  --secondary-color: #6c757d;
  --success-color: #28a745;
  --danger-color: #dc3545;
  --warning-color: #ffc107;
  --info-color: #17a2b8;
  --light-bg: #f8f9fa;
  --card-shadow: 0 2px 12px rgba(0,0,0,0.08);
  --hover-shadow: 0 4px 20px rgba(0,0,0,0.15);
  --border-radius: 12px;
  --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.memo-container {
  max-width: 1000px;
  margin: 0 auto;
  padding: 20px;
}

/* Add Memo Section */
.add-memo-section {
  background: linear-gradient(135deg, #B3E5FC 0%, #81D4FA 100%);
  padding: 30px;
  border-radius: var(--border-radius);
  margin-bottom: 40px;
  box-shadow: var(--card-shadow);
  color: white;
}

.section-header h3 {
  margin: 0 0 5px 0;
  font-size: 1.8em;
  font-weight: 600;
}

.section-header p {
  margin: 0 0 20px 0;
  opacity: 0.9;
}

.form-group {
  margin-bottom: 20px;
}

.form-group label {
  display: block;
  margin-bottom: 8px;
  font-weight: 500;
  font-size: 0.95em;
}

.form-control {
  width: 100%;
  padding: 12px 16px;
  border: 2px solid rgba(255,255,255,0.3);
  border-radius: 8px;
  font-size: 1em;
  transition: var(--transition);
  background: rgba(255,255,255,0.95);
  color: #333;
  min-height: 48px;
  line-height: 1.5;
}

.form-control option {
  padding: 8px;
  line-height: 1.8;
}

.form-control:focus {
  outline: none;
  border-color: white;
  background: white;
  box-shadow: 0 0 0 3px rgba(255,255,255,0.2);
}

.form-row {
  display: flex;
  gap: 15px;
  margin-bottom: 20px;
}

.form-row .form-group {
  flex: 1;
  margin-bottom: 0;
}

.col-md-6 {
  flex: 1;
}

/* ÈôÑ‰ª∂‰∏ä‰º†Âå∫Âüü */
.attachment-section {
  background: rgba(255,255,255,0.1);
  padding: 15px;
  border-radius: 8px;
  border: 2px dashed rgba(255,255,255,0.3);
}

.file-upload-area {
  display: flex;
  gap: 10px;
  align-items: center;
  flex-wrap: wrap;
  margin-bottom: 10px;
}

.btn-outline-secondary {
  background: rgba(255,255,255,0.2);
  border: 1px solid rgba(255,255,255,0.4);
  color: white;
  padding: 8px 16px;
  border-radius: 6px;
  cursor: pointer;
  transition: var(--transition);
  font-size: 0.9em;
}

.btn-outline-secondary:hover {
  background: rgba(255,255,255,0.3);
  transform: translateY(-2px);
}

.upload-hint {
  font-size: 0.85em;
  opacity: 0.8;
}

.attachment-preview {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  margin-top: 10px;
}

.preview-item {
  position: relative;
  background: rgba(255,255,255,0.2);
  padding: 8px 12px;
  border-radius: 6px;
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 0.9em;
}

.preview-item img {
  width: 50px;
  height: 50px;
  object-fit: cover;
  border-radius: 4px;
}

.preview-remove {
  cursor: pointer;
  margin-left: 5px;
  opacity: 0.7;
  transition: opacity 0.2s;
}

.preview-remove:hover {
  opacity: 1;
}

.btn-primary {
  background: white;
  color: #0288D1;
  border: none;
  padding: 14px 28px;
  border-radius: 8px;
  font-size: 1.1em;
  font-weight: 600;
  cursor: pointer;
  transition: var(--transition);
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(0,0,0,0.2);
}

.btn-lg {
  width: 100%;
}

#addMemoMessage {
  margin-top: 15px;
  padding: 12px;
  border-radius: 6px;
  font-weight: 500;
  text-align: center;
  display: none;
}

#addMemoMessage.success {
  background: rgba(40, 167, 69, 0.2);
  border: 1px solid rgba(40, 167, 69, 0.4);
  display: block;
}

#addMemoMessage.error {
  background: rgba(220, 53, 69, 0.2);
  border: 1px solid rgba(220, 53, 69, 0.4);
  display: block;
}

/* Â§áÂøòÂΩïÂàóË°® */
.memos-list {
  margin-top: 40px;
}

.list-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.list-header h3 {
  margin: 0;
  font-size: 1.8em;
  color: #333;
}

.stats .badge {
  padding: 8px 16px;
  border-radius: 20px;
  font-size: 0.9em;
}

.badge-info {
  background: var(--info-color);
  color: white;
}

.badge-success {
  background: var(--success-color);
  color: white;
}

.badge-warning {
  background: var(--warning-color);
  color: #333;
}

.filter-section {
  background: white;
  padding: 20px;
  border-radius: var(--border-radius);
  margin-bottom: 20px;
  box-shadow: var(--card-shadow);
}

.filter-buttons {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  margin-bottom: 15px;
}

.filter-btn {
  padding: 8px 18px;
  border: 2px solid #e0e0e0;
  background: white;
  border-radius: 20px;
  cursor: pointer;
  transition: var(--transition);
  font-size: 0.95em;
  font-weight: 500;
  color: #666;
}

.filter-btn:hover {
  border-color: var(--primary-color);
  color: var(--primary-color);
  transform: translateY(-2px);
}

.filter-btn.active {
  background: var(--primary-color);
  color: white;
  border-color: var(--primary-color);
}

.visibility-filters {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}

.visibility-btn {
  padding: 8px 18px;
  border: 2px solid #e0e0e0;
  background: white;
  border-radius: 20px;
  cursor: pointer;
  transition: var(--transition);
  font-size: 0.95em;
  font-weight: 500;
  color: #666;
}

.visibility-btn:hover {
  border-color: var(--success-color);
  color: var(--success-color);
  transform: translateY(-2px);
}

.visibility-btn.active {
  background: var(--success-color);
  color: white;
  border-color: var(--success-color);
}

.col-md-4 {
  flex: 1;
}

.search-box {
  margin-top: 15px;
}

.search-box .form-control {
  border: 2px solid #e0e0e0;
  background: #f8f9fa;
}

/* Â§áÂøòÂΩïÂç°Áâá */
.memo-item {
  background: white;
  border: 2px solid #f0f0f0;
  border-left: 4px solid var(--primary-color);
  border-radius: var(--border-radius);
  padding: 20px;
  margin-bottom: 20px;
  transition: var(--transition);
  position: relative;
  overflow: hidden;
}

.memo-item:hover {
  box-shadow: var(--hover-shadow);
  transform: translateY(-3px);
  border-left-width: 6px;
}

.memo-item.priority-urgent {
  border-left-color: var(--danger-color);
  background: linear-gradient(to right, rgba(220, 53, 69, 0.05) 0%, white 50%);
}

.memo-item.priority-important {
  border-left-color: var(--warning-color);
  background: linear-gradient(to right, rgba(255, 193, 7, 0.05) 0%, white 50%);
}

.memo-item.completed {
  opacity: 0.7;
  background: #f8f9fa;
}

.memo-item.completed .memo-content {
  text-decoration: line-through;
  color: #999;
}

.memo-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 12px;
  gap: 15px;
}

.header-left {
  flex: 1;
}

.header-right {
  display: flex;
  gap: 8px;
  align-items: center;
  flex-wrap: wrap;
}

.memo-title {
  margin: 0;
  font-size: 1.3em;
  color: #333;
  font-weight: 600;
}

.visibility-badge {
  padding: 4px 10px;
  border-radius: 15px;
  font-size: 0.8em;
  font-weight: 600;
  white-space: nowrap;
}

.visibility-badge.public {
  background: rgba(40, 167, 69, 0.1);
  color: var(--success-color);
  border: 1px solid var(--success-color);
}

.visibility-badge.private {
  background: rgba(108, 117, 125, 0.1);
  color: var(--secondary-color);
  border: 1px solid var(--secondary-color);
}

.priority-badge {
  padding: 4px 10px;
  border-radius: 15px;
  font-size: 0.8em;
  font-weight: 600;
  white-space: nowrap;
}

.priority-badge.urgent {
  background: rgba(220, 53, 69, 0.1);
  color: var(--danger-color);
  border: 1px solid var(--danger-color);
}

.priority-badge.important {
  background: rgba(255, 193, 7, 0.1);
  color: #f57c00;
  border: 1px solid var(--warning-color);
}

.memo-category {
  padding: 4px 12px;
  border-radius: 15px;
  font-size: 0.85em;
  font-weight: 500;
  white-space: nowrap;
}

.badge-general { background: #6c757d; color: white; }
.badge-todo { background: #007bff; color: white; }
.badge-idea { background: #ffc107; color: #333; }
.badge-note { background: #28a745; color: white; }

.memo-content {
  margin: 15px 0;
  line-height: 1.7;
  white-space: pre-wrap;
  color: #555;
  font-size: 1.05em;
}

/* ÈôÑ‰ª∂ÊòæÁ§∫ */
.memo-attachments {
  margin: 15px 0;
  padding: 15px;
  background: #f8f9fa;
  border-radius: 8px;
}

.images-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
  gap: 10px;
  margin-bottom: 10px;
}

.attachment-image {
  width: 100%;
  height: 150px;
  object-fit: cover;
  border-radius: 8px;
  cursor: pointer;
  transition: var(--transition);
}

.attachment-image:hover {
  transform: scale(1.05);
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

.files-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.file-item {
  display: inline-block;
  padding: 8px 12px;
  background: white;
  border: 1px solid #dee2e6;
  border-radius: 6px;
  text-decoration: none;
  color: #333;
  transition: var(--transition);
  font-size: 0.95em;
}

.file-item:hover {
  background: var(--primary-color);
  color: white;
  transform: translateX(5px);
}

.memo-footer {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 15px;
  padding-top: 15px;
  border-top: 1px solid #e0e0e0;
}

.memo-date {
  color: #999;
  font-size: 0.9em;
}

.memo-actions {
  display: flex;
  gap: 8px;
}

.btn-icon {
  background: transparent;
  border: none;
  cursor: pointer;
  padding: 6px 10px;
  border-radius: 6px;
  transition: var(--transition);
  font-size: 1.2em;
}

.btn-icon:hover {
  background: #f0f0f0;
  transform: scale(1.1);
}

.complete-icon {
  color: var(--success-color);
}

.delete-icon {
  color: var(--danger-color);
}

.btn-sync {
  color: var(--info-color);
  font-size: 1.1em;
}

.btn-sync:hover {
  background: rgba(23, 162, 184, 0.1);
}

/* Á©∫Áä∂ÊÄÅ */
.empty-state {
  text-align: center;
  padding: 60px 20px;
  color: #999;
}

.empty-icon {
  font-size: 4em;
  margin-bottom: 15px;
}

.empty-state p {
  font-size: 1.1em;
  margin: 5px 0;
}

/* ÂõæÁâáÊ®°ÊÄÅÊ°Ü */
.image-modal {
  display: none;
  position: fixed;
  z-index: 9999;
  padding-top: 60px;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  overflow: auto;
  background-color: rgba(0,0,0,0.9);
  animation: fadeIn 0.3s;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.modal-content {
  margin: auto;
  display: block;
  max-width: 90%;
  max-height: 80%;
  border-radius: 8px;
  animation: zoomIn 0.3s;
}

@keyframes zoomIn {
  from { transform: scale(0.5); }
  to { transform: scale(1); }
}

.close-modal {
  position: absolute;
  top: 20px;
  right: 40px;
  color: #f1f1f1;
  font-size: 50px;
  font-weight: bold;
  cursor: pointer;
  transition: 0.3s;
}

.close-modal:hover {
  color: #bbb;
}

#caption {
  margin: auto;
  display: block;
  width: 80%;
  max-width: 700px;
  text-align: center;
  color: #ccc;
  padding: 10px 0;
}

/* ÂìçÂ∫îÂºèËÆæËÆ° */
@media (max-width: 768px) {
  .memo-container {
    padding: 10px;
  }
  
  .add-memo-section {
    padding: 20px;
  }
  
  .form-row {
    flex-direction: column;
    gap: 0;
  }
  
  .form-row .form-group {
    margin-bottom: 20px;
  }
  
  .memo-header {
    flex-direction: column;
    gap: 10px;
  }
  
  .header-right {
    width: 100%;
    justify-content: flex-start;
  }
  
  .filter-buttons {
    justify-content: center;
  }
  
  .images-grid {
    grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
  }
}
</style>

<script>
// Use IndexedDB for larger file storage (supports MB to GB)
let db;
let localMemos = [];
let attachedImages = [];
let attachedFiles = [];

// Initialize IndexedDB
async function initDB() {
  return new Promise((resolve, reject) => {
    const request = indexedDB.open('MemoDB', 1);
    
    request.onerror = () => reject(request.error);
    request.onsuccess = () => {
      db = request.result;
      resolve(db);
    };
    
    request.onupgradeneeded = (event) => {
      const db = event.target.result;
      if (!db.objectStoreNames.contains('memos')) {
        db.createObjectStore('memos', { keyPath: 'id' });
      }
    };
  });
}

// Load memos from IndexedDB
async function loadMemos() {
  return new Promise((resolve, reject) => {
    const transaction = db.transaction(['memos'], 'readonly');
    const objectStore = transaction.objectStore('memos');
    const request = objectStore.getAll();
    
    request.onsuccess = () => {
      localMemos = request.result.sort((a, b) => b.id - a.id);
      resolve(localMemos);
    };
    request.onerror = () => reject(request.error);
  });
}

// Save memo to IndexedDB
async function saveMemo(memo) {
  return new Promise((resolve, reject) => {
    const transaction = db.transaction(['memos'], 'readwrite');
    const objectStore = transaction.objectStore('memos');
    const request = objectStore.add(memo);
    
    request.onsuccess = () => resolve(request.result);
    request.onerror = () => reject(request.error);
  });
}

// Delete memo from IndexedDB
async function deleteMemoFromDB(id) {
  return new Promise((resolve, reject) => {
    const transaction = db.transaction(['memos'], 'readwrite');
    const objectStore = transaction.objectStore('memos');
    const request = objectStore.delete(id);
    
    request.onsuccess = () => resolve();
    request.onerror = () => reject(request.error);
  });
}

// Update memo in IndexedDB
async function updateMemo(memo) {
  return new Promise((resolve, reject) => {
    const transaction = db.transaction(['memos'], 'readwrite');
    const objectStore = transaction.objectStore('memos');
    const request = objectStore.put(memo);
    
    request.onsuccess = () => resolve(request.result);
    request.onerror = () => reject(request.error);
  });
}

// Image upload handler
document.getElementById('imageUpload').addEventListener('change', function(e) {
  const files = Array.from(e.target.files);
  files.forEach(file => {
    if (file.type.startsWith('image/')) {
      const reader = new FileReader();
      reader.onload = function(event) {
        attachedImages.push({
          name: file.name,
          data: event.target.result,
          type: file.type
        });
        updateAttachmentPreview();
      };
      reader.readAsDataURL(file);
    }
  });
});

// File upload handler
document.getElementById('fileUpload').addEventListener('change', function(e) {
  const files = Array.from(e.target.files);
  files.forEach(file => {
    const reader = new FileReader();
    reader.onload = function(event) {
      attachedFiles.push({
        name: file.name,
        data: event.target.result,
        type: file.type,
        size: formatFileSize(file.size)
      });
      updateAttachmentPreview();
    };
    reader.readAsDataURL(file);
  });
});

// Update attachment preview
function updateAttachmentPreview() {
  const preview = document.getElementById('attachmentPreview');
  preview.innerHTML = '';
  
  attachedImages.forEach((img, index) => {
    const div = document.createElement('div');
    div.className = 'preview-item';
    div.innerHTML = `
      <img src="${img.data}" alt="${img.name}" />
      <span>${img.name}</span>
      <span class="preview-remove" onclick="removeAttachment('image', ${index})">‚úï</span>
    `;
    preview.appendChild(div);
  });
  
  attachedFiles.forEach((file, index) => {
    const div = document.createElement('div');
    div.className = 'preview-item';
    div.innerHTML = `
      <span>üìé ${file.name} (${file.size})</span>
      <span class="preview-remove" onclick="removeAttachment('file', ${index})">‚úï</span>
    `;
    preview.appendChild(div);
  });
}

// Remove attachment
function removeAttachment(type, index) {
  if (type === 'image') {
    attachedImages.splice(index, 1);
  } else {
    attachedFiles.splice(index, 1);
  }
  updateAttachmentPreview();
}

// Format file size
function formatFileSize(bytes) {
  if (bytes === 0) return '0 B';
  const k = 1024;
  const sizes = ['B', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}

// Add memo form submit handler
document.getElementById('memoForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const title = document.getElementById('memoTitle').value.trim();
  const content = document.getElementById('memoContent').value.trim();
  const category = document.getElementById('memoCategory').value;
  const priority = document.getElementById('memoPriority').value;
  const visibility = document.getElementById('memoVisibility').value;
  
  if (!content && attachedImages.length === 0 && attachedFiles.length === 0) {
    showMessage('Please enter content or add attachments', 'error');
    return;
  }
  
  const memo = {
    id: Date.now(),
    title: title || null,
    content: content,
    category: category,
    priority: priority,
    visibility: visibility,
    date: new Date().toLocaleString('en-US', {
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit'
    }),
    images: attachedImages.length > 0 ? attachedImages.map(img => img.data) : null,
    files: attachedFiles.length > 0 ? attachedFiles.map(f => ({
      name: f.name,
      data: f.data,
      size: f.size
    })) : null,
    completed: false
  };
  
  try {
    await saveMemo(memo);
    localMemos.unshift(memo);
    
    // Clear form
    document.getElementById('memoTitle').value = '';
    document.getElementById('memoContent').value = '';
    document.getElementById('memoCategory').value = 'general';
    document.getElementById('memoPriority').value = 'normal';
    document.getElementById('memoVisibility').value = 'public';
    attachedImages = [];
    attachedFiles = [];
    updateAttachmentPreview();
    
    const visMsg = visibility === 'private' ? ' (Local only - not synced)' : ' (Click sync button to publish)';
    showMessage('‚úì Memo added successfully!' + visMsg, 'success');
    displayMemos();
    updateStats();
  } catch (error) {
    console.error('Error saving memo:', error);
    showMessage('Error saving memo. Please try again.', 'error');
  }
});

// Show message
function showMessage(msg, type) {
  const msgDiv = document.getElementById('addMemoMessage');
  msgDiv.textContent = msg;
  msgDiv.className = type;
  setTimeout(() => {
    msgDiv.style.display = 'none';
  }, 3000);
}

// Display memos
let currentVisibility = 'all';

function displayMemos(filter = 'all', searchText = '') {
  const display = document.getElementById('memosDisplay');
  
  let filteredMemos = localMemos;
  
  // Filter by category
  if (filter !== 'all') {
    filteredMemos = filteredMemos.filter(m => m.category === filter);
  }
  
  // Filter by visibility
  if (currentVisibility !== 'all') {
    filteredMemos = filteredMemos.filter(m => (m.visibility || 'public') === currentVisibility);
  }
  
  // Filter by search
  if (searchText) {
    const search = searchText.toLowerCase();
    filteredMemos = filteredMemos.filter(m => 
      (m.title && m.title.toLowerCase().includes(search)) ||
      (m.content && m.content.toLowerCase().includes(search))
    );
  }
  
  if (filteredMemos.length === 0) {
    display.innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">üîç</div>
        <p>No memos found</p>
        <p class="text-muted">Try different filters or search criteria</p>
      </div>
    `;
    return;
  }
  
  display.innerHTML = filteredMemos.map(memo => {
    const priorityBadge = memo.priority === 'urgent' ? '<span class="priority-badge urgent">üî• Urgent</span>' :
                         memo.priority === 'important' ? '<span class="priority-badge important">‚≠ê Important</span>' : '';
    
    const visibilityBadge = (memo.visibility || 'public') === 'private' ? 
      '<span class="visibility-badge private">üîê Private</span>' :
      '<span class="visibility-badge public">üåç Public</span>';
    
    const syncButton = (memo.visibility || 'public') === 'public' ? 
      `<button class="btn-icon btn-sync" onclick="showSyncCommand(${memo.id})" title="Sync to server">
        <span>‚òÅÔ∏è</span>
      </button>` : '';
    
    const imagesHtml = memo.images ? `
      <div class="images-grid">
        ${memo.images.map(img => `<img src="${img}" alt="attachment" class="attachment-image" onclick="openImageModal('${img}')" />`).join('')}
      </div>
    ` : '';
    
    const filesHtml = memo.files ? `
      <div class="files-list">
        ${memo.files.map(file => `
          <a href="${file.data}" class="file-item" download="${file.name}">
            üìé ${file.name} ${file.size ? '(' + file.size + ')' : ''}
          </a>
        `).join('')}
      </div>
    ` : '';
    
    const attachmentsHtml = (imagesHtml || filesHtml) ? `
      <div class="memo-attachments">
        ${imagesHtml}
        ${filesHtml}
      </div>
    ` : '';
    
    return `
      <div class="memo-item priority-${memo.priority || 'normal'} ${memo.completed ? 'completed' : ''}" 
           data-category="${memo.category}" 
           data-visibility="${memo.visibility || 'public'}"
           data-id="${memo.id}">
        <div class="memo-header">
          <div class="header-left">
            <h5 class="memo-title">${memo.title || 'Untitled Memo'}</h5>
          </div>
          <div class="header-right">
            ${visibilityBadge}
            ${priorityBadge}
            <span class="memo-category badge-${memo.category}">${getCategoryName(memo.category)}</span>
          </div>
        </div>
        ${memo.content ? `<div class="memo-content">${memo.content}</div>` : ''}
        ${attachmentsHtml}
        <div class="memo-footer">
          <span class="memo-date">üïê ${memo.date}</span>
          <div class="memo-actions">
            ${syncButton}
            <button class="btn-icon" onclick="toggleComplete(${memo.id})" title="Mark as complete">
              <span class="complete-icon">${memo.completed ? '‚Ü∫' : '‚úì'}</span>
            </button>
            <button class="btn-icon" onclick="deleteMemo(${memo.id})" title="Delete">
              <span class="delete-icon">üóëÔ∏è</span>
            </button>
          </div>
        </div>
      </div>
    `;
  }).join('');
}

// Get category name
function getCategoryName(category) {
  const names = {
    general: 'üìã General',
    todo: '‚úÖ Todo',
    idea: 'üí° Idea',
    note: 'üìñ Note'
  };
  return names[category] || category;
}

// Show sync command
function showSyncCommand(memoId) {
  const memo = localMemos.find(m => m.id === memoId);
  if (!memo) return;
  
  const memoJson = JSON.stringify(memo);
  const command = `echo '${memoJson.replace(/'/g, "'\\''")}' | ruby sync_memo.rb sync`;
  
  const modal = prompt(
    `üì§ Copy and run this command in your terminal:\n\n${command}\n\nThen commit and push:\ngit add _data/memos.yml assets/\ngit commit -m "Add memo: ${memo.title || 'Untitled'}"\ngit push`,
    command
  );
}

// Update stats
function updateStats() {
  const publicMemos = localMemos.filter(m => (m.visibility || 'public') === 'public');
  const privateMemos = localMemos.filter(m => m.visibility === 'private');
  
  document.getElementById('memoCount').textContent = `${localMemos.length} memo${localMemos.length !== 1 ? 's' : ''}`;
  document.getElementById('publicCount').textContent = `${publicMemos.length} public`;
  document.getElementById('privateCount').textContent = `${privateMemos.length} private`;
}

// Toggle completion status
async function toggleComplete(id) {
  const memo = localMemos.find(m => m.id === id);
  if (memo) {
    memo.completed = !memo.completed;
    try {
      await updateMemo(memo);
      displayMemos();
      updateStats();
    } catch (error) {
      console.error('Error updating memo:', error);
    }
  }
}

// Delete memo
async function deleteMemo(id) {
  if (confirm('Are you sure you want to delete this memo?')) {
    try {
      await deleteMemoFromDB(id);
      localMemos = localMemos.filter(m => m.id !== id);
      showMessage('‚úì Memo deleted', 'success');
      displayMemos();
      updateStats();
    } catch (error) {
      console.error('Error deleting memo:', error);
      showMessage('Error deleting memo', 'error');
    }
  }
}

// Open image modal
function openImageModal(src) {
  const modal = document.getElementById('imageModal');
  const modalImg = document.getElementById('modalImage');
  modal.style.display = 'block';
  modalImg.src = src;
}

// Close image modal
function closeImageModal() {
  document.getElementById('imageModal').style.display = 'none';
}

// Filter buttons
document.querySelectorAll('.filter-btn').forEach(btn => {
  btn.addEventListener('click', function() {
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    this.classList.add('active');
    const category = this.getAttribute('data-category');
    const searchText = document.getElementById('searchInput').value;
    displayMemos(category, searchText);
  });
});

// Visibility filter buttons
document.querySelectorAll('.visibility-btn').forEach(btn => {
  btn.addEventListener('click', function() {
    document.querySelectorAll('.visibility-btn').forEach(b => b.classList.remove('active'));
    this.classList.add('active');
    currentVisibility = this.getAttribute('data-visibility');
    const category = document.querySelector('.filter-btn.active').getAttribute('data-category');
    const searchText = document.getElementById('searchInput').value;
    displayMemos(category, searchText);
  });
});

// Search function
document.getElementById('searchInput').addEventListener('input', function(e) {
  const activeFilter = document.querySelector('.filter-btn.active').getAttribute('data-category');
  displayMemos(activeFilter, e.target.value);
});

// Initialize display
document.addEventListener('DOMContentLoaded', async function() {
  try {
    await initDB();
    await loadMemos();
    if (localMemos.length > 0) {
      displayMemos();
    }
    updateStats();
    document.querySelector('.filter-btn[data-category="all"]').classList.add('active');
  } catch (error) {
    console.error('Error initializing app:', error);
    // Fallback to localStorage if IndexedDB fails
    localMemos = JSON.parse(localStorage.getItem('memos') || '[]');
    if (localMemos.length > 0) {
      displayMemos();
    }
    updateStats();
    document.querySelector('.filter-btn[data-category="all"]').classList.add('active');
  }
});
</script>
