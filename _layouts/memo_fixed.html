---
layout: page
---

{{ content }}

<div class="memo-container">
  <div class="add-memo-section">
    <div class="section-header">
      <h3>âœ¨ Add New Memo</h3>
      <p class="text-muted">Record your ideas, tasks and important notes</p>
    </div>
    <form id="memoForm">
      <div class="form-group">
        <label for="memoTitle">ğŸ“Œ Title</label>
        <input type="text" id="memoTitle" class="form-control" placeholder="Give your memo a title..." />
      </div>
      <div class="form-group">
        <label for="memoContent">ğŸ“ Content</label>
        <textarea id="memoContent" class="form-control" rows="4" placeholder="Enter your memo content... Supports multiple lines"></textarea>
      </div>
      <div class="form-row">
        <div class="form-group col-md-4">
          <label for="memoCategory">ğŸ·ï¸ Category</label>
          <select id="memoCategory" class="form-control">
            <option value="general">ğŸ“‹ General</option>
            <option value="todo">âœ… Todo</option>
            <option value="idea">ğŸ’¡ Idea</option>
            <option value="note">ğŸ“– Note</option>
          </select>
        </div>
        <div class="form-group col-md-4">
          <label for="memoPriority">â­ Priority</label>
          <select id="memoPriority" class="form-control">
            <option value="normal">Normal</option>
            <option value="important">Important</option>
            <option value="urgent">Urgent</option>
          </select>
        </div>
        <div class="form-group col-md-4">
          <label for="memoVisibility">ğŸ”’ Visibility</label>
          <select id="memoVisibility" class="form-control">
            <option value="public" selected>ğŸŒ Public (sync to server)</option>
            <option value="private">ğŸ” Private (local only)</option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <label>ğŸ“ Attachments</label>
        <div class="attachment-section">
          <div class="file-upload-area">
            <input type="file" id="imageUpload" accept="image/*" multiple style="display: none;" />
            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="document.getElementById('imageUpload').click()">
              ğŸ–¼ï¸ Add Images
            </button>
            <input type="file" id="fileUpload" multiple style="display: none;" />
            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="document.getElementById('fileUpload').click()">
              ğŸ“„ Add Files
            </button>
            <span class="upload-hint">Multiple files supported</span>
          </div>
          <div id="attachmentPreview" class="attachment-preview"></div>
        </div>
      </div>
      <button type="submit" class="btn btn-primary btn-lg btn-block">
        <span>â• Add Memo</span>
      </button>
    </form>
    <div id="addMemoMessage"></div>
  </div>

  <!-- Rest of the HTML content remains the same... -->
</div>

<style>
/* Copy all existing CSS here - not changing */
</style>

<script>
// Global variables
let db;
let localMemos = [];
let attachedImages = [];
let attachedFiles = [];
let currentVisibility = 'all';

// Initialize IndexedDB
async function initDB() {
  return new Promise((resolve, reject) => {
    const request = indexedDB.open('MemoDB', 1);
    
    request.onerror = () => reject(request.error);
    request.onsuccess = () => {
      db = request.result;
      resolve(db);
    };
    
    request.onupgradeneeded = (event) => {
      const db = event.target.result;
      if (!db.objectStoreNames.contains('memos')) {
        db.createObjectStore('memos', { keyPath: 'id' });
      }
    };
  });
}

// Load memos from IndexedDB
async function loadMemos() {
  return new Promise((resolve, reject) => {
    const transaction = db.transaction(['memos'], 'readonly');
    const objectStore = transaction.objectStore('memos');
    const request = objectStore.getAll();
    
    request.onsuccess = () => {
      localMemos = request.result.sort((a, b) => b.id - a.id);
      resolve(localMemos);
    };
    request.onerror = () => reject(request.error);
  });
}

// Save memo to IndexedDB
async function saveMemo(memo) {
  return new Promise((resolve, reject) => {
    const transaction = db.transaction(['memos'], 'readwrite');
    const objectStore = transaction.objectStore('memos');
    const request = objectStore.add(memo);
    
    request.onsuccess = () => resolve(request.result);
    request.onerror = () => reject(request.error);
  });
}

// Delete memo from IndexedDB
async function deleteMemoFromDB(id) {
  return new Promise((resolve, reject) => {
    const transaction = db.transaction(['memos'], 'readwrite');
    const objectStore = transaction.objectStore('memos');
    const request = objectStore.delete(id);
    
    request.onsuccess = () => resolve();
    request.onerror = () => reject(request.error);
  });
}

// Update memo in IndexedDB
async function updateMemo(memo) {
  return new Promise((resolve, reject) => {
    const transaction = db.transaction(['memos'], 'readwrite');
    const objectStore = transaction.objectStore('memos');
    const request = objectStore.put(memo);
    
    request.onsuccess = () => resolve(request.result);
    request.onerror = () => reject(request.error);
  });
}

// Helper functions (these don't need DOM)
function formatFileSize(bytes) {
  if (bytes === 0) return '0 B';
  const k = 1024;
  const sizes = ['B', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}

function getCategoryName(category) {
  const names = {
    general: 'ğŸ“‹ General',
    todo: 'âœ… Todo',
    idea: 'ğŸ’¡ Idea',
    note: 'ğŸ“– Note'
  };
  return names[category] || category;
}

// Global functions for onclick handlers
function removeAttachment(type, index) {
  if (type === 'image') {
    attachedImages.splice(index, 1);
  } else {
    attachedFiles.splice(index, 1);
  }
  updateAttachmentPreview();
}

function openImageModal(src) {
  const modal = document.getElementById('imageModal');
  const modalImg = document.getElementById('modalImage');
  if (modal && modalImg) {
    modal.style.display = 'block';
    modalImg.src = src;
  }
}

function closeImageModal() {
  const modal = document.getElementById('imageModal');
  if (modal) modal.style.display = 'none';
}

async function toggleComplete(id) {
  const memo = localMemos.find(m => m.id === id);
  if (memo) {
    memo.completed = !memo.completed;
    try {
      await updateMemo(memo);
      displayMemos();
      updateStats();
    } catch (error) {
      console.error('Error updating memo:', error);
    }
  }
}

async function deleteMemo(id) {
  if (confirm('Are you sure you want to delete this memo?')) {
    try {
      await deleteMemoFromDB(id);
      localMemos = localMemos.filter(m => m.id !== id);
      showMessage('âœ“ Memo deleted', 'success');
      displayMemos();
      updateStats();
    } catch (error) {
      console.error('Error deleting memo:', error);
      showMessage('Error deleting memo', 'error');
    }
  }
}

function showSyncCommand(memoId) {
  const memo = localMemos.find(m => m.id === memoId);
  if (!memo) return;
  
  const memoJson = JSON.stringify(memo);
  const command = `echo '${memoJson.replace(/'/g, "'\\''")}' | ruby sync_memo.rb sync`;
  
  prompt(
    `Copy and run this command:\n\n${command}`,
    command
  );
}

// DOM-dependent functions
function showMessage(msg, type) {
  const msgDiv = document.getElementById('addMemoMessage');
  if (!msgDiv) return;
  
  msgDiv.textContent = msg;
  msgDiv.className = type;
  msgDiv.style.display = 'block';
  setTimeout(() => {
    msgDiv.className = '';
    msgDiv.style.display = 'none';
  }, 3000);
}

function updateAttachmentPreview() {
  const preview = document.getElementById('attachmentPreview');
  if (!preview) return;
  
  preview.innerHTML = '';
  
  attachedImages.forEach((img, index) => {
    const div = document.createElement('div');
    div.className = 'preview-item';
    div.innerHTML = `
      <img src="${img.data}" alt="${img.name}" />
      <span>${img.name}</span>
      <span class="preview-remove" onclick="removeAttachment('image', ${index})">âœ•</span>
    `;
    preview.appendChild(div);
  });
  
  attachedFiles.forEach((file, index) => {
    const div = document.createElement('div');
    div.className = 'preview-item';
    div.innerHTML = `
      <span>ğŸ“ ${file.name} (${file.size})</span>
      <span class="preview-remove" onclick="removeAttachment('file', ${index})">âœ•</span>
    `;
    preview.appendChild(div);
  });
}

function displayMemos(filter = 'all', searchText = '') {
  const display = document.getElementById('memosDisplay');
  if (!display) return;
  
  let filteredMemos = localMemos;
  
  if (filter !== 'all') {
    filteredMemos = filteredMemos.filter(m => m.category === filter);
  }
  
  if (currentVisibility !== 'all') {
    filteredMemos = filteredMemos.filter(m => (m.visibility || 'public') === currentVisibility);
  }
  
  if (searchText) {
    const search = searchText.toLowerCase();
    filteredMemos = filteredMemos.filter(m => 
      (m.title && m.title.toLowerCase().includes(search)) ||
      (m.content && m.content.toLowerCase().includes(search))
    );
  }
  
  if (filteredMemos.length === 0) {
    display.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">No memos found</p>';
    return;
  }
  
  display.innerHTML = filteredMemos.map(memo => {
    const priorityClass = memo.priority === 'urgent' ? 'priority-urgent' : 
                          memo.priority === 'important' ? 'priority-important' : '';
    const completedClass = memo.completed ? 'completed' : '';
    const visibilityBadge = (memo.visibility || 'public') === 'public' 
      ? '<span class="visibility-badge public">ğŸŒ Public</span>'
      : '<span class="visibility-badge private">ğŸ” Private</span>';
    
    const syncButton = (memo.visibility || 'public') === 'public' 
      ? `<button class="btn-sync" onclick="showSyncCommand(${memo.id})" title="Sync to server">â˜ï¸</button>`
      : '';
    
    const imagesHtml = memo.images ? `
      <div class="images-grid">
        ${memo.images.map(img => `<img src="${img}" onclick="openImageModal('${img}')" />`).join('')}
      </div>
    ` : '';
    
    const filesHtml = memo.files ? `
      <div class="files-list">
        ${memo.files.map(file => `
          <a href="${file.data}" download="${file.name}">
            ğŸ“ ${file.name} ${file.size ? '(' + file.size + ')' : ''}
          </a>
        `).join('')}
      </div>
    ` : '';
    
    return `
      <div class="memo-item ${priorityClass} ${completedClass}">
        <div class="memo-header">
          <div class="header-left">
            <span class="category-badge">${getCategoryName(memo.category)}</span>
            ${visibilityBadge}
            ${memo.priority !== 'normal' ? `<span class="priority-badge">${memo.priority}</span>` : ''}
          </div>
          <div class="header-right">
            ${syncButton}
            <button class="btn-complete" onclick="toggleComplete(${memo.id})">${memo.completed ? 'â†º' : 'âœ“'}</button>
            <button class="btn-delete" onclick="deleteMemo(${memo.id})">ğŸ—‘ï¸</button>
          </div>
        </div>
        ${memo.title ? `<div class="memo-title">${memo.title}</div>` : ''}
        <div class="memo-content">${(memo.content || '').replace(/\n/g, '<br>')}</div>
        ${imagesHtml}
        ${filesHtml}
        <div class="memo-date">${memo.date}</div>
      </div>
    `;
  }).join('');
}

function updateStats() {
  const totalEl = document.getElementById('totalCount');
  const publicEl = document.getElementById('publicCount');
  const privateEl = document.getElementById('privateCount');
  
  if (totalEl) totalEl.textContent = localMemos.length;
  if (publicEl) publicEl.textContent = localMemos.filter(m => (m.visibility || 'public') === 'public').length;
  if (privateEl) privateEl.textContent = localMemos.filter(m => m.visibility === 'private').length;
}

// Initialize everything when DOM is ready
document.addEventListener('DOMContentLoaded', async function() {
  console.log('Initializing memo system...');
  
  try {
    // Initialize database
    await initDB();
    await loadMemos();
    console.log('Loaded', localMemos.length, 'memos');
    
    // Display memos
    displayMemos();
    updateStats();
    
    // Set active filters
    const allFilterBtn = document.querySelector('.filter-btn[data-category="all"]');
    const allVisBtn = document.querySelector('.visibility-btn[data-visibility="all"]');
    if (allFilterBtn) allFilterBtn.classList.add('active');
    if (allVisBtn) allVisBtn.classList.add('active');
    
    // Form submit handler
    const memoForm = document.getElementById('memoForm');
    if (memoForm) {
      memoForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        console.log('Form submitted');
        
        const title = document.getElementById('memoTitle').value.trim();
        const content = document.getElementById('memoContent').value.trim();
        const category = document.getElementById('memoCategory').value;
        const priority = document.getElementById('memoPriority').value;
        const visibility = document.getElementById('memoVisibility').value;
        
        if (!content && attachedImages.length === 0 && attachedFiles.length === 0) {
          showMessage('Please enter content or add attachments', 'error');
          return;
        }
        
        const memo = {
          id: Date.now(),
          title: title || null,
          content: content,
          category: category,
          priority: priority,
          visibility: visibility,
          date: new Date().toLocaleString('en-US', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
          }),
          images: attachedImages.length > 0 ? attachedImages.map(img => img.data) : null,
          files: attachedFiles.length > 0 ? attachedFiles.map(f => ({
            name: f.name,
            data: f.data,
            size: f.size
          })) : null,
          completed: false
        };
        
        try {
          await saveMemo(memo);
          localMemos.unshift(memo);
          
          // Clear form
          document.getElementById('memoTitle').value = '';
          document.getElementById('memoContent').value = '';
          document.getElementById('memoCategory').value = 'general';
          document.getElementById('memoPriority').value = 'normal';
          document.getElementById('memoVisibility').value = 'public';
          attachedImages = [];
          attachedFiles = [];
          updateAttachmentPreview();
          
          const visMsg = visibility === 'private' ? ' (Local only)' : ' (Click â˜ï¸ to sync)';
          showMessage('âœ“ Memo added!' + visMsg, 'success');
          displayMemos();
          updateStats();
        } catch (error) {
          console.error('Error:', error);
          showMessage('Error: ' + error.message, 'error');
        }
      });
    }
    
    // Image upload handler
    const imageUpload = document.getElementById('imageUpload');
    if (imageUpload) {
      imageUpload.addEventListener('change', function(e) {
        const files = Array.from(e.target.files);
        files.forEach(file => {
          if (file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = function(event) {
              attachedImages.push({
                name: file.name,
                data: event.target.result,
                type: file.type
              });
              updateAttachmentPreview();
            };
            reader.readAsDataURL(file);
          }
        });
      });
    }
    
    // File upload handler
    const fileUpload = document.getElementById('fileUpload');
    if (fileUpload) {
      fileUpload.addEventListener('change', function(e) {
        const files = Array.from(e.target.files);
        files.forEach(file => {
          const reader = new FileReader();
          reader.onload = function(event) {
            attachedFiles.push({
              name: file.name,
              data: event.target.result,
              type: file.type,
              size: formatFileSize(file.size)
            });
            updateAttachmentPreview();
          };
          reader.readAsDataURL(file);
        });
      });
    }
    
    // Filter buttons
    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        const category = this.getAttribute('data-category');
        const searchText = document.getElementById('searchInput')?.value || '';
        displayMemos(category, searchText);
      });
    });
    
    // Visibility filter buttons
    document.querySelectorAll('.visibility-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        document.querySelectorAll('.visibility-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        currentVisibility = this.getAttribute('data-visibility');
        const activeFilter = document.querySelector('.filter-btn.active');
        const category = activeFilter ? activeFilter.getAttribute('data-category') : 'all';
        const searchText = document.getElementById('searchInput')?.value || '';
        displayMemos(category, searchText);
      });
    });
    
    // Search input
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
      searchInput.addEventListener('input', function(e) {
        const activeFilter = document.querySelector('.filter-btn.active');
        const category = activeFilter ? activeFilter.getAttribute('data-category') : 'all';
        displayMemos(category, e.target.value);
      });
    }
    
    console.log('Memo system initialized successfully!');
    
  } catch (error) {
    console.error('Initialization error:', error);
    showMessage('Error initializing: ' + error.message, 'error');
  }
});
</script>
